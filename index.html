<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VDLPYL - San Francisco de Borja</title>
</head>
<body>
    <!-- Mensaje de bienvenida -->
    <div id="welcome-message"></div>

    <!-- Botones de autenticación -->
    <button id="login-btn">Iniciar sesión</button>
    <button id="register-btn">Registrarse</button>
    <button id="logout-btn" style="display: none;">Cerrar sesión</button>

    <!-- Formularios de inicio de sesión y registro -->
    <div id="auth-form" style="display: none;">
        <input type="email" id="email" placeholder="Correo electrónico" required>
        <input type="password" id="password" placeholder="Contraseña" required>
        <input type="text" id="name" placeholder="Nombre completo" style="display: none;">
        <button id="submit-btn">Enviar</button>
    </div>
    

    <script type="module">
        // Importar Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";

        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAjOZEvWP1EsGxAmU5Zy2JvuSSiovkUJPw",
            authDomain: "vdlpyl-sanfranciscodeborja.firebaseapp.com",
            projectId: "vdlpyl-sanfranciscodeborja",
            storageBucket: "vdlpyl-sanfranciscodeborja.appspot.com",
            messagingSenderId: "401125990033",
            appId: "1:401125990033:web:bc1e0bda0bcb5319af6930"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Referencias a los elementos HTML
        const loginButton = document.getElementById("login-btn");
        const registerButton = document.getElementById("register-btn");
        const logoutButton = document.getElementById("logout-btn");
        const welcomeMessage = document.getElementById("welcome-message");
        const authForm = document.getElementById("auth-form");
        const submitButton = document.getElementById("submit-btn");
        const emailInput = document.getElementById("email");
        const passwordInput = document.getElementById("password");

        // Verificar el estado del usuario
        onAuthStateChanged(auth, async (user) => {
    if (user) {
        // Usuario autenticado
        const userRef = doc(db, "users", user.uid);
        const userDoc = await getDoc(userRef);

        if (userDoc.exists()) {
            const userData = userDoc.data();
            welcomeMessage.textContent = `Bienvenido, ${userData.name}`;
        } else {
            // Si no existe el documento, lo creamos
            await setDoc(userRef, {
                email: user.email,
                name: "Sin nombre",
                createdAt: new Date()
            });
            welcomeMessage.textContent = "Bienvenido, Sin nombre";
        }

        loginButton.style.display = "none";
        registerButton.style.display = "none";
        logoutButton.style.display = "block";
    } else {
        // Usuario no autenticado
        welcomeMessage.textContent = "";
        loginButton.style.display = "block";
        registerButton.style.display = "block";
        logoutButton.style.display = "none";
    }
});





        // Iniciar sesión
        loginButton.addEventListener("click", () => {
            authForm.style.display = "block";
            submitButton.textContent = "Iniciar sesión";

            submitButton.onclick = () => {
                const email = emailInput.value;
                const password = passwordInput.value;
                signInWithEmailAndPassword(auth, email, password)
                    .then(() => {
                        console.log("Inicio de sesión exitoso");
                        authForm.style.display = "none"; // Ocultar formulario
                        emailInput.value = "";
                        passwordInput.value = "";
                    })
                    .catch((error) => {
                        console.error("Error al iniciar sesión:", error.message);
                    });
            };
        });

        // Registrarse
        registerButton.addEventListener("click", () => {
    authForm.style.display = "block";
    submitButton.textContent = "Registrarse";

    // Mostrar el campo de nombre
    document.getElementById("name").style.display = "block";

    submitButton.onclick = () => {
        const email = emailInput.value;
        const password = passwordInput.value;
        const name = document.getElementById("name").value;

        createUserWithEmailAndPassword(auth, email, password)
            .then(async (userCredential) => {
                const user = userCredential.user;

                // Guardar el nombre en Firestore
                const userRef = doc(db, "users", user.uid);
                await setDoc(userRef, {
                    email: user.email,
                    name: name,
                    createdAt: new Date()
                });

                console.log("Registro exitoso y datos guardados en Firestore");
            })
            .catch((error) => {
                console.error("Error al registrarse:", error);
            });
    };
});










        // Cerrar sesión
        logoutButton.addEventListener("click", () => {
            signOut(auth)
                .then(() => {
                    console.log("Sesión cerrada exitosamente");
                })
                .catch((error) => {
                    console.error("Error al cerrar sesión:", error.message);
                });
        });
    </script>
</body>
</html>
